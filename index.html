import { useEffect, useState } from "react";
import { ethers } from "ethers";

const stakingAddress = "PASTE_STAKING";
const dxAddress = "PASTE_DX";
const usdtAddress = "0x55d398326f99059fF775485246999027B3197955";

const stakingABI = [
 "function stakeUSDT(uint amount,address ref)",
 "function stakeDX(uint amount,address ref)",
 "function claim()",
 "function userInfo(address) view returns(uint,uint,uint,uint,uint,uint)"
];

const erc20ABI = [
 "function approve(address spender,uint amount) returns(bool)",
 "function balanceOf(address) view returns(uint)"
];

export default function App(){

const [wallet,setWallet] = useState("");
const [data,setData] = useState({});
const [provider,setProvider]=useState();
const [signer,setSigner]=useState();
const [staking,setStaking]=useState();
const [dx,setDX]=useState();
const [usdt,setUSDT]=useState();

async function connect(){

await window.ethereum.request({method:'eth_requestAccounts'});

const prov = new ethers.providers.Web3Provider(window.ethereum);
const sign = prov.getSigner();

setProvider(prov);
setSigner(sign);

const st = new ethers.Contract(stakingAddress,stakingABI,sign);
const dxC = new ethers.Contract(dxAddress,erc20ABI,sign);
const usdtC = new ethers.Contract(usdtAddress,erc20ABI,sign);

setStaking(st);
setDX(dxC);
setUSDT(usdtC);

const addr = await sign.getAddress();
setWallet(addr);

load(st,addr);
}

async function load(st,addr){
const d = await st.userInfo(addr);

setData({
 stake: ethers.utils.formatUnits(d[0],18),
 daily: ethers.utils.formatUnits(d[1],18),
 total: ethers.utils.formatUnits(d[2],18),
 ref: ethers.utils.formatUnits(d[3],18),
 level: ethers.utils.formatUnits(d[4],18),
 pending: ethers.utils.formatUnits(d[5],18)
});
}

async function approveUSDT(v){
await usdt.approve(stakingAddress,ethers.utils.parseUnits(v,18));
}

async function stakeUSDT(v){
const ref = new URLSearchParams(window.location.search).get("ref") || ethers.constants.AddressZero;
await staking.stakeUSDT(ethers.utils.parseUnits(v,18),ref);
connect();
}

async function claim(){
await staking.claim();
connect();
}

useEffect(()=>{
if(wallet && staking){
const i = setInterval(()=>load(staking,wallet),5000);
return ()=>clearInterval(i);
}
},[wallet,staking]);

return(
<div className="bg-black min-h-screen text-white">

<div className="flex justify-between p-4 bg-gray-900">
<h1 className="text-yellow-400 text-xl">DimeX Dashboard</h1>
<button onClick={connect} className="bg-yellow-500 px-4 py-2 rounded">
{wallet ? "Connected" : "Connect Wallet"}
</button>
</div>

<div className="p-6 grid md:grid-cols-3 gap-4">

<Card title="Total Stake" value={data.stake}/>
<Card title="Daily Reward" value={data.daily}/>
<Card title="Pending" value={data.pending}/>
<Card title="Direct Income" value={data.ref}/>
<Card title="Level Income" value={data.level}/>
<Card title="Total Income" value={data.total}/>

</div>

<div className="p-6">

<StakeBox onStake={stakeUSDT} onApprove={approveUSDT}/>
<button onClick={claim} className="bg-green-500 px-6 py-3 rounded">
Claim Rewards
</button>

</div>

</div>
);
}

function Card({title,value}){
return(
<div className="bg-gray-900 p-4 rounded">
<div className="text-gray-400">{title}</div>
<div className="text-2xl text-yellow-400">{value}</div>
</div>
);
}

function StakeBox({onStake,onApprove}){
const [amt,setAmt]=useState("");

return(
<div className="bg-gray-900 p-4 rounded">
<input
value={amt}
onChange={e=>setAmt(e.target.value)}
placeholder="Amount"
className="bg-black p-2 mr-2"
/>
<button onClick={()=>onApprove(amt)} className="bg-blue-500 px-3 py-2 mr-2">
Approve
</button>
<button onClick={()=>onStake(amt)} className="bg-yellow-500 px-3 py-2">
Stake USDT
</button>
</div>
);
}
